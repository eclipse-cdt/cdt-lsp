<?xml version="1.0" encoding="UTF-8"?>
<?eclipse version="3.4"?>
<!--
   Copyright (c) 2023 Contributors to the Eclipse Foundation.

   This program and the accompanying materials
   are made available under the terms of the Eclipse Public License 2.0
   which accompanies this distribution, and is available at
   https://www.eclipse.org/legal/epl-2.0/

   SPDX-License-Identifier: EPL-2.0
-->
<plugin>
   <extension
         point="org.eclipse.core.runtime.preferences">
      <initializer
            class="org.eclipse.cdt.lsp.internal.editor.EditorPreferenceInitializer">
      </initializer>
   </extension>
   <extension-point id="serverProvider" name="%Server.name" schema="schema/serverProvider.exsd"/>
   <extension-point id="logProvider" name="%Logger.name" schema="schema/logProvider.exsd"/>
   <extension
         point="org.eclipse.ui.editors">
      <editor
            class="org.eclipse.cdt.lsp.internal.editor.CLspEditor"
            contributorClass="org.eclipse.ui.editors.text.TextEditorActionContributor"
            default="false"
            icon="icons/c.png"
            id="org.eclipse.cdt.lsp.CEditor"
            name="%CEditor.name">
         <contentTypeBinding
               contentTypeId="org.eclipse.cdt.core.cSource">
         </contentTypeBinding>
         <contentTypeBinding
               contentTypeId="org.eclipse.cdt.core.cxxSource">
         </contentTypeBinding>
         <contentTypeBinding
               contentTypeId="org.eclipse.cdt.core.cHeader">
         </contentTypeBinding>
         <contentTypeBinding
               contentTypeId="org.eclipse.cdt.core.cxxHeader">
         </contentTypeBinding>
      </editor>
   </extension>
   <extension
         point="org.eclipse.lsp4e.languageServer">
      <server
            class="org.eclipse.cdt.lsp.internal.server.CLanguageServerStreamConnectionProvider"
            id="org.eclipse.cdt.lsp.server"
            label="C/C++ Language Server"
            serverInterface="org.eclipse.cdt.lsp.services.ClangdLanguageServer"
            singleton="true">
      </server>
      <contentTypeMapping
            contentType="org.eclipse.cdt.core.cSource"
            id="org.eclipse.cdt.lsp.server">
         <enabledWhen
               description="LSP Editor active">
            <reference
                  definitionId="org.eclipse.cdt.lsp.server.enable.editorHasLanguageServer">
            </reference>
         </enabledWhen>
      </contentTypeMapping>
      <contentTypeMapping
            contentType="org.eclipse.cdt.core.cxxSource"
            id="org.eclipse.cdt.lsp.server">
         <enabledWhen
         	description="LSP Editor active">
            <reference
                  definitionId="org.eclipse.cdt.lsp.server.enable.editorHasLanguageServer">
            </reference>
         </enabledWhen>
      </contentTypeMapping>
      <contentTypeMapping
            contentType="org.eclipse.cdt.core.cxxHeader"
            id="org.eclipse.cdt.lsp.server">
         <enabledWhen
               description="LSP Editor active">
            <reference
                  definitionId="org.eclipse.cdt.lsp.server.enable.editorHasLanguageServer">
            </reference>
         </enabledWhen>
      </contentTypeMapping>
   </extension>
   <extension
         point="org.eclipse.tm4e.registry.grammars">
      <!-- This content type binding is needed because the cpp content type from TM4E (source.cpp) 
      does not cover C++ standard library header without file extension -->         
      <scopeNameContentTypeBinding
            contentTypeId="org.eclipse.cdt.core.cxxHeader"
            scopeName="source.cpp">
      </scopeNameContentTypeBinding>
   </extension>
   <extension
         point="org.eclipse.ui.bindings">
      <key
            commandId="org.eclipse.tm4e.languageconfiguration.toggleLineCommentCommand"
            contextId="org.eclipse.ui.textEditorScope"
            schemeId="org.eclipse.ui.defaultAcceleratorConfiguration"
            sequence="Ctrl+7">
      </key>
   </extension>
   <extension
         point="org.eclipse.ui.ide.editorAssociationOverride">
      <editorAssociationOverride
            class="org.eclipse.cdt.lsp.internal.editor.CEditorAssociationOverride"
            id="org.eclipse.cdt.lsp.editorAssociationOverride">
      </editorAssociationOverride>
   </extension>
   <extension
         point="org.eclipse.ui.navigator.navigatorContent">
      <navigatorContent
            activeByDefault="true"
            contentProvider="org.eclipse.cdt.lsp.internal.ui.navigator.CSymbolsContentProvider"
            icon="icons/c.png"
            id="org.eclipse.cdt.lsp.navigator.content"
            labelProvider="org.eclipse.lsp4e.outline.SymbolsLabelProvider"
            name="%SymbolsLabelProvider.name"
            priority="normal">
	    <triggerPoints>
        <and>
           <or>
              <instanceof
                    value="org.eclipse.cdt.core.model.ITranslationUnit">
              </instanceof>
              <instanceof
                    value="org.eclipse.lsp4e.outline.SymbolsModel$DocumentSymbolWithURI">
              </instanceof></or>
           <test
                 forcePluginActivation="true"
                 property="org.eclipse.cdt.lsp.server.enable.hasLanguageServer"
                 value="true">
           </test>
        </and>
   	   </triggerPoints>
   	   <possibleChildren>
          <or>
             <instanceof
                   value="org.eclipse.lsp4e.outline.SymbolsModel$DocumentSymbolWithURI">
             </instanceof>
          </or>
	   </possibleChildren>
 	   <override
             policy="InvokeAlwaysRegardlessOfSuppressedExt"
             suppressedExtensionId="org.eclipse.cdt.ui.navigator.content"/>
	   <actionProvider
			class="org.eclipse.cdt.lsp.internal.ui.navigator.CSymbolsOpenActionProvider"
			id="org.eclipse.cdt.lsp.navigator.actions.open"
			overrides="org.eclipse.ui.navigator.resources.OpenActions"
			priority="normal">
		 <enablement>
			<or>
          <instanceof
                value="org.eclipse.lsp4e.outline.SymbolsModel$DocumentSymbolWithURI">
          </instanceof>
			</or>
         </enablement>			
       </actionProvider>
    <commonSorter
          class="org.eclipse.lsp4e.outline.OutlineSorter"
          id="org.eclipse.lsp4e.outline.OutlineSorter">
    </commonSorter>
      </navigatorContent>
   </extension>
   <extension
         point="org.eclipse.ui.navigator.viewer">
      <viewerContentBinding
            viewerId="org.eclipse.ui.navigator.ProjectExplorer">
         <includes>
            <contentExtension
                  pattern="org.eclipse.cdt.lsp.navigator.content">
            </contentExtension>
         </includes>
      </viewerContentBinding>
   </extension>
   <extension
         point="org.eclipse.core.contenttype.contentTypes">
      <file-association
            content-type="org.eclipse.cdt.core.cxxHeader"
            file-names="charconv,bit,compare,concepts,coroutine,format,numbers,ranges,source_location,span,syncstream,version,barrier,latch,semaphore,stop_token">
      </file-association>
   </extension>
   <extension
         point="org.eclipse.core.expressions.propertyTesters">
      <propertyTester
            class="org.eclipse.cdt.lsp.internal.server.HasLanguageServerPropertyTester"
            id="org.eclipse.cdt.lsp.server.enable.hasLanguageServerPropertyTester"
            namespace="org.eclipse.cdt.lsp.server.enable"
            properties="hasLanguageServer"
            type="java.lang.Object">
      </propertyTester>
      <propertyTester
            class="org.eclipse.cdt.lsp.internal.editor.SpellingEnabled"
            id="org.eclipse.cdt.lsp.editor.spelling.EnabledTester"
            namespace="org.eclipse.cdt.lsp.editor.spelling"
            properties="enabled"
            type="java.lang.Object">
      </propertyTester>
   </extension>
   <extension
         point="org.eclipse.core.expressions.definitions">
      <definition
            id="org.eclipse.cdt.lsp.server.enable.editorHasLanguageServer">
	            <with
	                  variable="uri">
		            <test
	                forcePluginActivation="true"
	                property="org.eclipse.cdt.lsp.server.enable.hasLanguageServer"
	                value="true">
		            </test>
	            </with>        
      </definition>
   </extension>
   <extension
         point="org.eclipse.ui.editorActions">
         <!-- Still using the deprecated extension until there is a proper replacement for the RulerDoubleClick action (see https://bugs.eclipse.org/bugs/show_bug.cgi?id=455985) -->
      <editorContribution
            id="org.eclipse.cdt.lsp.CEditor.BreakpointRulerActions"
            targetID="org.eclipse.cdt.lsp.CEditor">
         <action
               actionID="RulerDoubleClick"
               class="org.eclipse.debug.ui.actions.RulerToggleBreakpointActionDelegate"
               id="org.eclipse.cdt.lsp.CEditor.RulerToggleBreakpointAction"
               label="unusedlabel">
         </action>
      </editorContribution>
   </extension>
   <extension
         point="org.eclipse.ui.popupMenus">
      <viewerContribution
            id="org.eclipse.cdt.lsp.CEditor.EditorRulerActions"
            targetID="org.eclipse.cdt.lsp.CEditor.RulerContext">
         <action
               class="org.eclipse.cdt.debug.internal.ui.actions.breakpoints.CBreakpointPropertiesRulerActionDelegate"
               helpContextId="breakpoint_properties_action_context"
               id="org.eclipse.cdt.lsp.CEditor.CBreakpointPropertiesRulerActionDelegate"
               label="%RulerBreakpointProperties.label"
               menubarPath="debug">
         </action>
         <action
               class="org.eclipse.cdt.debug.internal.ui.actions.breakpoints.CAddDynamicPrintfInteractiveRulerActionDelegate"
               helpContextId="add_breakpoint_interactive_action_context"
               id="org.eclipse.cdt.lsp.CEditor.RulerCreateDynamicPrintfInteractiveAction"
               label="%AddDynamicPrintfInteractive.label"
               menubarPath="debug">
         </action>
         <action
               class="org.eclipse.debug.ui.actions.RulerEnableDisableBreakpointActionDelegate"
               id="org.eclipse.cdt.lsp.CEditor.RulerEnableDisableBreakpointAction"
               label="%EnableBreakpoint.label"
               menubarPath="debug">
         </action>
         <action
               class="org.eclipse.cdt.debug.internal.ui.actions.breakpoints.CAddBreakpointInteractiveRulerActionDelegate"
               helpContextId="add_breakpoint_interactive_action_context"
               id="org.eclipse.cdt.lsp.CEditor.RulerCreateBreakpointInteractiveAction"
               label="%AddBreakpointInteractive.label"
               menubarPath="debug">
         </action>
         <action
               class="org.eclipse.debug.ui.actions.RulerToggleBreakpointActionDelegate"
               definitionId="org.eclipse.debug.ui.commands.ToggleBreakpoint"
               icon="icons/elcl16/line_brkpt_co.gif"
               id="org.eclipse.cdt.lsp.CEditor.RulerToggleBreakpointAction"
               label="%AddBreakpoint.label"
               menubarPath="debug">
         </action>
      </viewerContribution>
      <viewerContribution
            id="org.eclipse.cdt.lsp.CEditor.EditorPopupActions"
            targetID="org.eclipse.cdt.lsp.CEditor.EditorContext">
         <visibility>
            <and>
               <systemProperty
                     name="org.eclipse.cdt.debug.ui.debuggerActive"
                     value="true">
               </systemProperty>
               <objectClass
                     name="org.eclipse.jface.text.ITextSelection">
               </objectClass>
            </and>
         </visibility>
         <action
               class="org.eclipse.cdt.debug.internal.ui.actions.AddExpressionEditorActionDelegate"
               helpContextId="add_expression_action_context"
               icon="icons/etool16/watch_exp.gif"
               id="org.eclipse.cdt.lsp.CEditor.AddExpressionActionDelegate"
               label="%AddExpressionAction.label"
               menubarPath="additions">
         </action>
         <action
               class="org.eclipse.cdt.debug.internal.ui.actions.ResumeAtLineActionDelegate"
               enablesFor="1"
               helpContextId="resume_at_line_action_context"
               icon="icons/elcl16/resume_at_line_co.gif"
               id="org.eclipse.cdt.lsp.CEditor.ResumeAtLineActionDelegate"
               label="%ResumeAtLineAction.label"
               menubarPath="additions">
         </action>
         <action
               class="org.eclipse.cdt.debug.internal.ui.actions.MoveToLineActionDelegate"
               enablesFor="1"
               helpContextId="move_to_line_action_context"
               icon="icons/elcl16/move_to_line_co.gif"
               id="org.eclipse.cdt.lsp.CEditor.MoveToLineActionDelegate"
               label="%MoveToLineAction.label"
               menubarPath="additions">
         </action>
         <action
               class="org.eclipse.debug.ui.actions.RunToLineActionDelegate"
               definitionId="org.eclipse.debug.ui.commands.RunToLine"
               helpContextId="run_to_line_action_context"
               id="org.eclipse.cdt.lsp.CEditor.RunToLine"
               label="%RunToLineAction.label"
               menubarPath="additions">
         </action>
      </viewerContribution>
   </extension>
   
   <extension
         point="org.eclipse.ui.genericeditor.hoverProviders">
      <hoverProvider
            class="org.eclipse.cdt.lsp.internal.editor.DebugHoverProvider"
            contentType="org.eclipse.core.runtime.text"
            id="org.eclipse.cdt.lsp.editor.DebugHoverProvider"
            isBefore="org.eclipse.lsp4e.operations.hover.LSPTextHover">
      </hoverProvider>
   </extension>
   <extension
         point="org.eclipse.cdt.ui.CFileImageProvider">
      <imageDescriptor
            class="org.eclipse.cdt.lsp.internal.editor.LspEditorFileImageDescriptor">
      </imageDescriptor>
   </extension>
   <extension
         point="org.eclipse.ui.preferencePages">
      <page
            category="org.eclipse.cdt.ui.preferences.CPluginPreferencePage"
            class="org.eclipse.cdt.lsp.ui.EditorConfigurationPage"
            id="org.eclipse.cdt.lsp.editor.preferencePage"
            name="%EditorPreferencePage.name">
      </page>
      <page
	        name="%SaveActionsPreferencePage.name"
	        category="org.eclipse.cdt.lsp.editor.preferencePage"
	        class="org.eclipse.cdt.lsp.internal.ui.SaveActionsConfigurationPage"
	        id="org.eclipse.cdt.lsp.editor.SaveActionsPreferencePage">
	      <keywordReference id="org.eclipse.cdt.ui.saveactions"/>
	      <keywordReference id="org.eclipse.cdt.ui.common"/>
	      <keywordReference id="org.eclipse.cdt.ui.ceditor"/>
      </page>      
   </extension>
   <extension
         point="org.eclipse.ui.propertyPages">
      <page
            category="org.eclipse.cdt.ui.newui.Page_head_general"
            class="org.eclipse.cdt.lsp.ui.EditorConfigurationPage"
            id="org.eclipse.cdt.lsp.editor.propertyPage"
            name="%EditorPreferencePage.name">
         <filter
               name="projectNature"
               value="org.eclipse.cdt.core.cnature">
         </filter>
         <enabledWhen>
            <adapt
                  type="org.eclipse.core.resources.IProject">
            </adapt>
         </enabledWhen>
      </page>
      <page
            category="org.eclipse.cdt.lsp.editor.propertyPage"
            class="org.eclipse.cdt.lsp.internal.ui.SaveActionsConfigurationPage"
            id="org.eclipse.cdt.lsp.editor.SaveActionsPropertyPage"
            name="%SaveActionsPreferencePage.name">
          <keywordReference id="org.eclipse.cdt.ui.saveactions"/>
	      <keywordReference id="org.eclipse.cdt.ui.common"/>
	      <keywordReference id="org.eclipse.cdt.ui.ceditor"/>
       <filter
             name="projectNature"
             value="org.eclipse.cdt.core.cnature">
       </filter>
       <enabledWhen>
          <adapt
                type="org.eclipse.core.resources.IProject">
          </adapt>
       </enabledWhen>
      </page>      
   </extension>
   <extension
         point="org.eclipse.ui.genericeditor.reconcilers">
      <reconciler
            class="org.eclipse.cdt.lsp.internal.editor.CSpellingReconciler"
            contentType="org.eclipse.core.runtime.text">
         <enabledWhen>
            <test
                  property="org.eclipse.cdt.lsp.editor.spelling.enabled">
            </test>
         </enabledWhen>
      </reconciler>
   </extension>
   <extension
         point="org.eclipse.ui.genericeditor.icons">
      <icon
            contentType="org.eclipse.cdt.core.cSource"
            icon="icons/c.png">
      </icon>
      <icon
            contentType="org.eclipse.cdt.core.cxxSource"
            icon="icons/cpp.png">
      </icon>
      <icon
            contentType="org.eclipse.cdt.core.cHeader"
            icon="icons/h.png">
      </icon>
      <icon
            contentType="org.eclipse.cdt.core.cxxHeader"
            icon="icons/h.png">
      </icon>
   </extension>
   <extension
         point="org.eclipse.core.runtime.adapters">
      <factory
            adaptableType="org.eclipse.ui.internal.genericeditor.ExtensionBasedTextEditor"
            class="org.eclipse.cdt.debug.internal.ui.actions.RetargettableActionAdapterFactory">
         <adapter
               type="org.eclipse.cdt.debug.internal.ui.actions.IMoveToLineTarget">
         </adapter>
      </factory>
   </extension>  
</plugin>

